<!DOCTYPE html>
<html lang="ja-jp"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">DirectX12の描画処理 #3 [Devlog #004] | nishihi6</title>
<meta property="og:title" content="DirectX12の描画処理 #3 [Devlog #004] | nishihi6" />
<meta name="twitter:title" content="DirectX12の描画処理 #3 [Devlog #004] | nishihi6" />
<meta itemprop="name" content="DirectX12の描画処理 #3 [Devlog #004] | nishihi6" />
<meta name="application-name" content="DirectX12の描画処理 #3 [Devlog #004] | nishihi6" />
<meta property="og:site_name" content="nishihi6" />

<meta name="description" content="Minimal Hugo blog theme with light and dark mode support">
<meta itemprop="description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta property="og:description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta name="twitter:description" content="Minimal Hugo blog theme with light and dark mode support" />

<meta property="og:locale" content="ja-jp" />
<meta name="language" content="ja-jp" />



  <meta itemprop="image" content="https://nishihi6.github.io/blog/" />
  <meta property="og:image" content="https://nishihi6.github.io/blog/" />
  <meta name="twitter:image" content="https://nishihi6.github.io/blog/" />
  <meta name="twitter:image:src" content="https://nishihi6.github.io/blog/" />




    
    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2023-08-27T21:44:55&#43;0900 />
    <meta property="article:published_time" content=2023-08-27T21:44:55&#43;0900 />

    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "DirectX12の描画処理 #3 [Devlog #004]",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2023-08-27",
        "description": "",
        "wordCount":  1635 ,
        "mainEntityOfPage": "True",
        "dateModified": "2023-08-27",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "nishihi6"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.117.0">

    

    <link rel="canonical" href="https://nishihi6.github.io/blog/posts/devlog_dx12_03/">
    <link href="/blog/style.min.840eada6dfddec7b8ccfcf867f039bf80b1f16a265ec6e01dc553a3dddc9d509.css" rel="stylesheet">
    <link href="/blog/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/blog/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/blog/favicon.ico">




<link rel="manifest" href="https://nishihi6.github.io/blog/site.webmanifest">

<meta name="msapplication-config" content="/blog/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/blog/icons/favicon.svg">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous" />


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
    crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ]
    });"></script>

    </head>
<body data-theme = "dark" class="notransition">

<script src="/blog/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="https://nishihi6.github.io/blog/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/blog/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/blog/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/blog/pages/about/">
                        About
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">DirectX12の描画処理 #3 [Devlog #004]</h1>
                
                
                <div class="post-meta">
                    <time datetime="2023-08-27T21:44:55&#43;09:00" itemprop="datePublished"> 27 Aug 2023 </time>
                </div>
                
            </header>
            <details class="toc">
                <summary><b>Table of Contents</b></summary>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#directx12の環境構築">DirectX12の環境構築</a>
      <ul>
        <li><a href="#初期化">初期化</a>
          <ul>
            <li><a href="#direct3d-d3d">Direct3D (D3D)</a></li>
            <li><a href="#directx-graphics-infrastructure-dxgi">DirectX Graphics Infrastructure (DXGI)</a></li>
            <li><a href="#デバイスの初期化">デバイスの初期化</a></li>
            <li><a href="#graphicsdeviceh">GraphicsDevice.h</a></li>
            <li><a href="#graphicsdevicecpp">GraphicsDevice.cpp</a></li>
            <li><a href="#描画コマンドの初期化">描画コマンドの初期化</a></li>
            <li><a href="#graphicsdeviceh-1">GraphicsDevice.h</a></li>
            <li><a href="#graphicsdevicecpp-1">GraphicsDevice.cpp</a></li>
            <li><a href="#スワップチェーンの初期化">スワップチェーンの初期化</a></li>
            <li><a href="#graphicsdeviceh-2">GraphicsDevice.h</a></li>
            <li><a href="#graphicsdevicecpp-2">GraphicsDevice.cpp</a></li>
            <li><a href="#applicationcpp">Application.cpp</a></li>
            <li><a href="#windowh">Window.h</a></li>
            <li><a href="#スワップチェーンのレンダーターゲットビュー">スワップチェーンのレンダーターゲットビュー</a></li>
            <li><a href="#rtvheaph">RTVHeap.h</a></li>
            <li><a href="#rtvheapcpp">RTVHeap.cpp</a></li>
            <li><a href="#systemh">System.h</a></li>
            <li><a href="#graphicsdeviceh-3">GraphicsDevice.h</a></li>
            <li><a href="#graphicsdevicecpp-3">GraphicsDevice.cpp</a></li>
            <li><a href="#デバッグレイヤーの実装">デバッグレイヤーの実装</a></li>
            <li><a href="#graphocsdeviceh">GraphocsDevice.h</a></li>
            <li><a href="#graphicsdevicecpp-4">GraphicsDevice.cpp</a></li>
            <li><a href="#バックバッファの描画">バックバッファの描画</a></li>
            <li><a href="#graphicsdeviceh-4">GraphicsDevice.h</a></li>
            <li><a href="#graphicsdevicecpp-5">GraphicsDevice.cpp</a></li>
            <li><a href="#applicationcpp-1">Application.cpp</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
            </details><div class="page-content">
                <h1 id="directx12を使った描画処理">DirectX12を使った描画処理</h1>
<hr>
<h2 id="directx12の環境構築">DirectX12の環境構築</h2>
<h3 id="初期化">初期化</h3>
<h4 id="direct3d-d3d">Direct3D (D3D)</h4>
<p><mark>Direct3D(D3D)</mark>とは、DirectXの中の3DグラフィクスAPIの一部であり、多様なグラフィクスハードウェア上でハードウェアアクセラレーションを活用したグラフィクスの表示や操作を行うことができる</p>
<p><mark>D3D12Device</mark>は、D3D12(Direct3D 12)のインターフェースの一つで、グラフィクスハードウェアへの低レベルのアクセスを提供し、<strong>リソースの作成やコマンドのキューの管理</strong>などの主要な機能をもつ</p>
<h4 id="directx-graphics-infrastructure-dxgi">DirectX Graphics Infrastructure (DXGI)</h4>
<p><mark>DXGI</mark>とは、DirectXのコンポーネントの一つであり、アダプター（グラフィクスカード）、モニター、フレームバッファなどのリソース管理や、スワップチェーンの操作などのタスクを行う
<br>DXGIは、Direct3Dが多様なグラフィクスハードウェア上で一貫して動作するための基盤となる</p>
<p><mark>DXGIFactory</mark>は、DXGIの中でも主要なインターフェースの一つで、<strong>アダプター（グラフィクスカード）やモニターの情報を取得</strong>したり、<strong>スワップチェーンを作成するためのメソッドを提供</strong>する</p>
<h4 id="デバイスの初期化">デバイスの初期化</h4>
<p>D3D12DeviceとDXGIFactoryは初期化に最低限必要になる</p>
<p>リンクするライブラリファイル<code>d3d12.lib</code>と<code>dxgi.lib</code>をソースコード内の記述でリンクして、<code>d3d12.h</code>と<code>dxgi1_6.h</code>をインクルードする</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// stdafx.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// D3D12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#pragma comment(lib,&#34;d3d12.lib&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma comment(lib,&#34;dxgi.lib&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;d3d12.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dxgi1_6.h&gt;</span><span class="cp">
</span></span></span></code></pre></div><p><code>Graphics</code>フォルダに<code>GraphicsDevice.h</code>と<code>GraphicsDevice.cpp</code>を追加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">dev-dx12-202308（プロジェクト名）
</span></span><span class="line"><span class="cl">└─ Source
</span></span><span class="line"><span class="cl">   ├─ Application
</span></span><span class="line"><span class="cl">   │  ├─ Application.h
</span></span><span class="line"><span class="cl">   │  └─ Application.cpp
</span></span><span class="line"><span class="cl">   ├─ Graphics
</span></span><span class="line"><span class="cl">   │  ├─ GraphicsDevice.h
</span></span><span class="line"><span class="cl">   │  └─ GraphicsDevice.cpp
</span></span><span class="line"><span class="cl">   ├─ System
</span></span><span class="line"><span class="cl">   │  ├─ Utility
</span></span><span class="line"><span class="cl">   │  │  ├─ Utility.h
</span></span><span class="line"><span class="cl">   │  │  └─ Utility.cpp
</span></span><span class="line"><span class="cl">   │  ├─ Window
</span></span><span class="line"><span class="cl">   │  │  ├─ Window.h
</span></span><span class="line"><span class="cl">   │  │  └─ Window.cpp
</span></span><span class="line"><span class="cl">   │  └─ System.h
</span></span><span class="line"><span class="cl">   ├─ stdafx.h
</span></span><span class="line"><span class="cl">   └─ stdafx.cpp
</span></span></code></pre></div><h4 id="graphicsdeviceh">GraphicsDevice.h</h4>
<h5 id="graphicsdeviceクラス">GraphicsDeviceクラス</h5>
<p>初期化を行う<code>Init()</code>関数を宣言し、GraphicsDeviceクラスオブジェクトを生成する<code>Instance()</code>関数を定義する（シングルトン）</p>
<p>ファクトリー関数<code>CreateFactory()</code>を宣言（DXGIFactoryの機能）</p>
<p>デバイス関数<code>CreateDevice()</code>を宣言（D3D12Deviceの機能）</p>
<p><code>ID3D12Device8</code>はコマンド アロケーター、コマンド リスト、コマンド キュー、フェンス、リソース、パイプライン状態オブジェクト、ヒープ、ルート署名、サンプラー、および多くのリソース ビューを作成するために使用される
<br>DirectX12のアプリケーションでのグラフィックスと計算タスクの中心的なインターフェース
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12device8">詳細</a></p>
<p><code>IDXGIFactory6</code>は全画面表示の遷移を処理するDXGIオブジェクトを生成するためのメソッドを実装するなど、グラフィックリソースの管理や設定を行うためのインターフェース
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi1_6/nn-dxgi1_6-idxgifactory6">詳細</a></p>
<p><code>IDXGISwapChain4</code>はダブルバッファリングのプロセス中のフロントバッファとバックバッファの間でのバッファ交換を管理するインターフェース
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi1_5/nn-dxgi1_5-idxgiswapchain4">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//GraphicsDevice.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GraphicsDevice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="n">GraphicsDevice</span><span class="o">&amp;</span> <span class="n">Instance</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">static</span> <span class="n">GraphicsDevice</span> <span class="n">instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">CreateFactory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="nf">CreateDevice</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">enum</span> <span class="k">class</span> <span class="nc">GPUTier</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">NVIDIA</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Amd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Intel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Arm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Qualcomm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12Device8</span><span class="o">&gt;</span>		<span class="n">m_pDevice</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IDXGIFactory6</span><span class="o">&gt;</span>		<span class="n">m_pDxgiFactory</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IDXGISwapChain4</span><span class="o">&gt;</span>		<span class="n">m_pSwapChain</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">GraphicsDevice</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">GraphicsDevice</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h4 id="graphicsdevicecpp">GraphicsDevice.cpp</h4>
<h5 id="graphicsdeviceinit関数">GraphicsDevice::Init()関数</h5>
<p><code>CreateFactory()</code>と<code>CreateDevice()</code>を実行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;GraphicsDevice.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateFactory</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;ファクトリー作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateDevice</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;D3D12デバイス作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdevicecreatefactory関数">GraphicsDevice::CreateFactory()関数</h5>
<p><code>CreateDXGIFactory2()</code>関数は、モニターやグラボのスペックを取得するなど、DirectXアプリケーションでのグラフィックスリソースの管理や操作を行うためのDXGIファクトリインスタンス（<code>IDXGIFactory2</code>）を作成する
<br>▶ 第一引数はDXGIのデバッグレイヤーを有効にするためのフラグ
<br>▶ 第二引数と第三引数はインターフェースへのポインタ（<code>IID_PPV_ARGS</code>マクロを使ってうまくやってる）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">CreateFactory</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UINT</span> <span class="n">flagsDXGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">flagsDXGI</span> <span class="o">|=</span> <span class="n">DXGI_CREATE_FACTORY_DEBUG</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">CreateDXGIFactory2</span><span class="p">(</span><span class="n">flagsDXGI</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="n">m_pDxgiFactory</span><span class="p">.</span><span class="n">GetAddressOf</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdevicecreatedevice関数">GraphicsDevice::CreateDevice()関数</h5>
<p><code>IDXGIAdapter</code>は、DXGIを通じてグラフィックスアダプタの情報取得や管理を行うためのインターフェース
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi/nn-dxgi-idxgiadapter">詳細</a></p>
<p><code>DXGI_ADAPTER_DESC</code>はDXGIに関連する構造体で、グラフィックスアダプタ（グラボなど）に関する詳細な情報を提供する
<br>IDXGIAdapterインターフェースのGetDescメソッドを通じて取得される情報を格納するために使用される
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi/ns-dxgi-dxgi_adapter_desc">詳細</a></p>
<p>１回目のfor文ではGPUドライバーを検索して、あればその情報を格納する</p>
<p>２回目のfor文では優先度の高いGPUドライバーを使用する</p>
<p><code>D3D_FEATURE_LEVEL</code>は、Direct3Dで使用される列挙型で、グラフィクスハードウェアがサポートするDirect3Dの機能セットを識別する
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3dcommon/ne-d3dcommon-d3d_feature_level">詳細</a></p>
<p><code>D3D12CreateDevice()</code>は、指定されたアダプタと指定された機能レベルでDirect3D 12デバイスを作成する関数
<br>▶ 第一引数はアダプタ（<code>IDXGIAdapter</code>）を指定するポインタ
<br>▶ 第二引数はサポートすべき最小の機能レベル（<code>D3D_FEATURE_LEVEL</code>）を指定、
<br>▶ 第三引数と第四引数は作成するインターフェースへのポインタ（<code>IID_PPV_ARGS</code>マクロを使ってうまくやってる）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-d3d12createdevice">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">CreateDevice</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IDXGIAdapter</span><span class="o">&gt;</span> <span class="n">pSelectAdapter</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IDXGIAdapter</span><span class="o">&gt;&gt;</span> <span class="n">pAdapters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">DXGI_ADAPTER_DESC</span><span class="o">&gt;</span> <span class="n">descs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">UINT</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pAdapters</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">HRESULT</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">m_pDxgiFactory</span><span class="o">-&gt;</span><span class="n">EnumAdapters</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pAdapters</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DXGI_ERROR_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">descs</span><span class="p">.</span><span class="n">push_back</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">		<span class="n">pAdapters</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetDesc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descs</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">GPUTier</span> <span class="n">gpuTier</span> <span class="o">=</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Kind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">descs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Description</span><span class="p">).</span><span class="n">find</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;NVIDIA&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">pSelectAdapter</span> <span class="o">=</span> <span class="n">pAdapters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Description</span><span class="p">).</span><span class="n">find</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;Amd&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">gpuTier</span> <span class="o">&gt;</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Amd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">pSelectAdapter</span> <span class="o">=</span> <span class="n">pAdapters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">				<span class="n">gpuTier</span> <span class="o">=</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Amd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Description</span><span class="p">).</span><span class="n">find</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;Intel&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">gpuTier</span> <span class="o">&gt;</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Intel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">pSelectAdapter</span> <span class="o">=</span> <span class="n">pAdapters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">				<span class="n">gpuTier</span> <span class="o">=</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Intel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Description</span><span class="p">).</span><span class="n">find</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;Arm&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">gpuTier</span> <span class="o">&gt;</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Arm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">pSelectAdapter</span> <span class="o">=</span> <span class="n">pAdapters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">				<span class="n">gpuTier</span> <span class="o">=</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Arm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Description</span><span class="p">).</span><span class="n">find</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;Qualcomm&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">gpuTier</span> <span class="o">&gt;</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Qualcomm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">pSelectAdapter</span> <span class="o">=</span> <span class="n">pAdapters</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">				<span class="n">gpuTier</span> <span class="o">=</span> <span class="n">GPUTier</span><span class="o">::</span><span class="n">Qualcomm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D3D_FEATURE_LEVEL</span> <span class="n">levels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">D3D_FEATURE_LEVEL_12_1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">D3D_FEATURE_LEVEL_12_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">D3D_FEATURE_LEVEL_11_1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">D3D_FEATURE_LEVEL_11_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D3D_FEATURE_LEVEL</span> <span class="n">featureLevel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">lv</span> <span class="p">:</span> <span class="n">levels</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">D3D12CreateDevice</span><span class="p">(</span><span class="n">pSelectAdapter</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="n">lv</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pDevice</span><span class="p">))</span> <span class="o">==</span> <span class="n">S_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">featureLevel</span> <span class="o">=</span> <span class="n">lv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>※追記※
<br><strong>ビルドは通るのにプリコンパイルヘッダーでの定義がコーディング中にエラー表示される問題の解決方法</strong>
<br>プリコンパイルヘッダーがインクルード対象パスに入っていればよいので、<code>プロジェクトプロパティ</code>-&gt;<code>C/C++</code>-&gt;<code>全般</code>-&gt;<code>追加のインクルードディレクトリ</code>にプリコンパイルヘッダーがあるディレクトリ<code>$(PrjectDir)Source</code>を追加すれば解決する
<br>参考記事１：<a href="https://freelifetech.com/memo-pre-compile-header/">https://freelifetech.com/memo-pre-compile-header/</a>
<br>参考記事２：<a href="https://solid.kmckk.com/SOLID/doc/latest/user_guide/add-include-directory.html">https://solid.kmckk.com/SOLID/doc/latest/user_guide/add-include-directory.html</a></p>
<h4 id="描画コマンドの初期化">描画コマンドの初期化</h4>
<p>GPUが実行する命令のリスト<strong>コマンドリスト</strong>を指定した順序でGPUに転送するための仕組みが<strong>コマンドキュー</strong></p>
<h4 id="graphicsdeviceh-1">GraphicsDevice.h</h4>
<h5 id="graphicsdeviceクラス-1">GraphicsDeviceクラス</h5>
<p>コマンドリスト関数<code>CreateCommandList()</code>を宣言（D3D12Deviceの機能）</p>
<p><code>ID3D12CommandAllocator</code>はコマンドリストに必要なメモリ（コマンドの記録領域）を割り当てるオブジェクト
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12commandallocator">詳細</a></p>
<p><code>ID3D12GraphicsCommandList6</code>はレンダリング用のコマンドリストをカプセル化し、コマンドを記述するオブジェクト
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12graphicscommandlist">詳細</a></p>
<p><code>ID3D12CommandAllocator</code>はコマンドリストをGPUに送信するオブジェクト
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12commandqueue">詳細</a></p>
<p>参考記事：<a href="https://tositeru.blogspot.com/2019/01/direct3d122gpu.html">https://tositeru.blogspot.com/2019/01/direct3d122gpu.html</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GraphicsDevice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">bool</span> <span class="n">CreateCommandList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12CommandAllocator</span><span class="o">&gt;</span>			<span class="n">m_pCmdAllocator</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12GraphicsCommandList6</span><span class="o">&gt;</span>		<span class="n">m_pCmdList</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12CommandQueue</span><span class="o">&gt;</span>				<span class="n">m_pCmdQueue</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="graphicsdevicecpp-1">GraphicsDevice.cpp</h4>
<h5 id="graphicsdeviceinit関数-1">GraphicsDevice::Init()関数</h5>
<p><code>CreateCommandList()</code>を実行</p>
<h5 id="graphicsdevicecreatecommandlist関数">GraphicsDevice::CreateCommandList()関数</h5>
<p><code>CreateCommandAllocator()</code>は、コマンドアロケータオブジェクトを作成する関数
<br>▶ 第一引数は作成するコマンドアロケータの種類を指定
<br>▶ 第二引数はコマンドアロケータへのインターフェースのGUIDを指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-createcommandallocator">詳細</a></p>
<p><code>CreateCommandList()</code>は、コマンドリストを作成する関数
<br>▶ 第一引数は複数のGPUアダプターを利用するときに利用する（単一GPUの場合は0）
<br>▶ 第二引数は作成するコマンドリストの種類を指定
<br>▶ 第三引数はコマンドアロケーターオブジェクトへのポインタを指定
<br>▶ 第四引数はパイプライン状態オブジェクトへのポインタを指定
<br>▶ 第五引数はコマンドリストインターフェースのGUIDを指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-createcommandlist">詳細</a></p>
<p><code>D3D12_COMMAND_QUEUE_DESC</code>は、コマンドキューを記述する構造体
<br>▶ <code>cmdQueueDesc.Flags</code>は<code>D3D12_COMMAND_QUEUE_FLAGS</code>列挙体のフラグを指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_command_queue_flags">詳細</a>）
<br>▶ <code>cmdQueueDesc.NodeMask</code>は複数のGPUアダプターを利用するときに利用する（単一GPUの場合は0
<br>▶ <code>cmdQueueDesc.Priority</code>は<code>D3D12_COMMAND_QUEUE_PRIORITY</code>列挙定数としてのコマンドキューの優先順位を指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_command_queue_priority">詳細</a>）
<br>▶ <code>cmdQueueDesc.Type</code>は<code>D3D12_COMMAND_LIST_TYPE</code>の列挙定数を指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_command_list_type">詳細</a>）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ns-d3d12-d3d12_command_queue_desc">詳細</a></p>
<p><code>CreateCommandQueue()</code>は、コマンドキューを作成する関数
<br>▶ 第一引数はコマンド キューを記述する<code>D3D12_COMMAND_QUEUE_DESC</code>を指定
<br>▶ 第二引数はコマンドキューインターフェイスのGUIDを指定
<br>▶ 第三引数はコマンドキューの<code>ID3D12CommandQueue</code>インターフェイスへのポインターを受け取るメモリ ブロックへのポインタを指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-createcommandqueue">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateCommandList</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;コマンドリストの作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">CreateCommandList</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">m_pDevice</span><span class="o">-&gt;</span><span class="n">CreateCommandAllocator</span><span class="p">(</span><span class="n">D3D12_COMMAND_LIST_TYPE_DIRECT</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pCmdAllocator</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">hr</span> <span class="o">=</span> <span class="n">m_pDevice</span><span class="o">-&gt;</span><span class="n">CreateCommandList</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">D3D12_COMMAND_LIST_TYPE_DIRECT</span><span class="p">,</span> <span class="n">m_pCmdAllocator</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pCmdList</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_COMMAND_QUEUE_DESC</span> <span class="n">cmdQueueDesc</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">	<span class="n">cmdQueueDesc</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">D3D12_COMMAND_QUEUE_FLAG_NONE</span><span class="p">;</span>				<span class="c1">// タイムアウトなし
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">cmdQueueDesc</span><span class="p">.</span><span class="n">NodeMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>										<span class="c1">// アダプターを1つしか使わないときは0でいい
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">cmdQueueDesc</span><span class="p">.</span><span class="n">Priority</span> <span class="o">=</span> <span class="n">D3D12_COMMAND_QUEUE_PRIORITY_NORMAL</span><span class="p">;</span>	<span class="c1">// プライオリティは特に指定なし
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">cmdQueueDesc</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">D3D12_COMMAND_LIST_TYPE_DIRECT</span><span class="p">;</span>				<span class="c1">// コマンドリストと合わせる
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// キュー生成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hr</span> <span class="o">=</span> <span class="n">m_pDevice</span><span class="o">-&gt;</span><span class="n">CreateCommandQueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdQueueDesc</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pCmdQueue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="スワップチェーンの初期化">スワップチェーンの初期化</h4>
<p>フレームバッファの表示側と描画側を切り替えるための仕組みが<strong>スワップチェーン</strong></p>
<h4 id="graphicsdeviceh-2">GraphicsDevice.h</h4>
<h5 id="graphicsdeviceクラス-2">GraphicsDeviceクラス</h5>
<p>スワップチェーン関数<code>CreateSwapChain()</code>を宣言（DXGIFactoryの機能）</p>
<p><code>IDXGISwapChain4</code>はダブルバッファリングのプロセス中のフロントバッファとバックバッファの間でのバッファ交換を管理するインターフェース
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi1_5/nn-dxgi1_5-idxgiswapchain4">詳細</a></p>
<p><code>Init()</code>関数に引数を追加（スワップチェーンの作成のために必要）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GraphicsDevice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">Init</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">bool</span> <span class="n">CreateSwaphcain</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IDXGISwapChain4</span><span class="o">&gt;</span>		<span class="n">m_pSwapChain</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="graphicsdevicecpp-2">GraphicsDevice.cpp</h4>
<h5 id="graphicsdeviceinit関数-2">GraphicsDevice::Init()関数</h5>
<p><code>GraphicsDevice::Init()</code>関数に引数を追加</p>
<p><code>CreateSwapchain()</code>を実行</p>
<h5 id="graphicsdevicecreateswapchain関数">GraphicsDevice::CreateSwapchain()関数</h5>
<p><code>DXGI_SWAP_CHAIN_DESC1</code>はスワップチェーンについて説明する構造体
<br>▶ <code>swapchainDesc.Width</code>は解像度の幅を表す値
<br>▶ <code>swapchainDesc.Height</code>は解像度の高さを表す値
<br>▶ <code>swapchainDesc.Format</code>はピクセルフォーマットを<code>DXGI_FORMAT</code>列挙で指定（<code>DXGI_FORMAT_R8G8B8A8_UNORM</code>はカラー チャネルごとに8ビットと8ビットアルファをサポートする4コンポーネントの32ビット符号なし正規化整数形式を表す）（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgiformat/ne-dxgiformat-dxgi_format">列挙の詳細</a>）
<br>▶ <code>swapchainDesc.SampleDesc.Count</code>はピクセルあたりのマルチサンプル数をマルチサンプリングパラメーターを記述する<code>DXGI_SAMPLE_DESC</code>構造体で指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgicommon/ns-dxgicommon-dxgi_sample_desc">構造体の詳細</a>）
<br>▶ <code>swapchainDesc.BufferUsage</code>はバックバッファの使用制限について（サーフェス使用量とCPUアクセスオプション）を<code>DXGI_USAGE</code>フラグで指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/direct3ddxgi/dxgi-usage">フラグの詳細</a>）
<br>▶ <code>swapchainDesc.BufferCount</code>はスワップするバッファの数を指定
<br>▶ <code>swapchainDesc.SwapEffect</code>はスワップ方法を指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi/ne-dxgi-dxgi_swap_effect">列挙の詳細</a>）
<br>▶ <code>swapchainDesc.Flags</code>はスワップチェインの動作のオプションを指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi/ne-dxgi-dxgi_swap_chain_flag">列挙の詳細</a>）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi1_2/ns-dxgi1_2-dxgi_swap_chain_desc1">詳細</a></p>
<p><code>CreateSwapChainForHwnd()</code>は、スワップチェーンを作成する関数
<br>▶ 第一引数は作成したコマンドキューのポインタ
<br>▶ 第二引数はウィンドウハンドル
<br>▶ 第三引数は<code>DXGI_SWAP_CHAIN_DESC1</code>構造体へのポインタ
<br>▶ 第四引数は<code>DXGI_SWAP_CHAIN_FULLSCREEN_DESC</code>構造体のアドレス（オプション）
<br>▶ 第五引数は<code>IDXGIOutput</code>インタフェースのポインタ（オプション）
<br>▶ 第六引数は<code>DXGISwapChain1</code>インタフェースのポインタを格納する変数のアドレス
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi1_2/nf-dxgi1_2-idxgifactory2-createswapchainforhwnd">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateSwapchain</span><span class="p">(</span><span class="n">hWnd</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;スワップチェインの作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">CreateSwapchain</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DXGI_SWAP_CHAIN_DESC1</span> <span class="n">swapchainDesc</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">Format</span> <span class="o">=</span> <span class="n">DXGI_FORMAT_R8G8B8A8_UNORM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">SampleDesc</span><span class="p">.</span><span class="n">Count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">DXGI_USAGE_BACK_BUFFER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">BufferCount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">SwapEffect</span> <span class="o">=</span> <span class="n">DXGI_SWAP_EFFECT_FLIP_DISCARD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">swapchainDesc</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">m_pDxgiFactory</span><span class="o">-&gt;</span><span class="n">CreateSwapChainForHwnd</span><span class="p">(</span><span class="n">m_pCmdQueue</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="n">hWnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swapchainDesc</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="p">(</span><span class="n">IDXGISwapChain1</span><span class="o">**</span><span class="p">)</span><span class="n">m_pSwapChain</span><span class="p">.</span><span class="n">GetAddressOf</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="applicationcpp">Application.cpp</h4>
<h5 id="applicationexecute関数">Application::Execute()関数</h5>
<p><code>GraphicsDevice::Init()</code>関数に引数を追加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Application.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Application</span><span class="o">::</span><span class="n">Execute</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Instance</span><span class="p">().</span><span class="n">Init</span><span class="p">(</span><span class="n">m_window</span><span class="p">.</span><span class="n">GetWndHandle</span><span class="p">(),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;グラフィックスデバイス初期化失敗。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="windowh">Window.h</h4>
<h5 id="applicationexecute関数-1">Application::Execute()関数</h5>
<p><code>GetWndHandle()</code>関数でウィンドウハンドルを取得</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Window.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Window</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">HWND</span> <span class="n">GetWndHandle</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">m_hWnd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><h4 id="スワップチェーンのレンダーターゲットビュー">スワップチェーンのレンダーターゲットビュー</h4>
<p>スワップチェーンのバッファをどのように使うのかを指示するビューを作成する</p>
<p>ビューを作成するためにはディスクリプタヒープが必要となる</p>
<p>ディスクリプタは、リソース（テクスチャ、バッファなど）やビュー（レンダーターゲットビュー、デプスステンシルビューなど）に関する情報を格納するためのデータ構造</p>
<p>ヒープ領域を確保し、ビューの情報を書き込んでいく</p>
<p><code>Graphics</code>フォルダに<code>RTVHeap</code>フォルダを作成し、<code>RTVHeap.h</code>と<code>RTVHeap.cpp</code>を追加</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">dev-dx12-202308（プロジェクト名）
</span></span><span class="line"><span class="cl">└─ Source
</span></span><span class="line"><span class="cl">   ├─ Application
</span></span><span class="line"><span class="cl">   │  ├─ Application.h
</span></span><span class="line"><span class="cl">   │  └─ Application.cpp
</span></span><span class="line"><span class="cl">   ├─ Graphics
</span></span><span class="line"><span class="cl">   │  ├─ GraphicsDevice.h
</span></span><span class="line"><span class="cl">   │  ├─ GraphicsDevice.cpp
</span></span><span class="line"><span class="cl">   │  └─ RTVHeap
</span></span><span class="line"><span class="cl">   │     ├─ RTVHeap.h
</span></span><span class="line"><span class="cl">   │     └─ RTVHeap.cpp
</span></span><span class="line"><span class="cl">   ├─ System
</span></span><span class="line"><span class="cl">   │  ├─ Utility
</span></span><span class="line"><span class="cl">   │  │  ├─ Utility.h
</span></span><span class="line"><span class="cl">   │  │  └─ Utility.cpp
</span></span><span class="line"><span class="cl">   │  ├─ Window
</span></span><span class="line"><span class="cl">   │  │  ├─ Window.h
</span></span><span class="line"><span class="cl">   │  │  └─ Window.cpp
</span></span><span class="line"><span class="cl">   │  └─ System.h
</span></span><span class="line"><span class="cl">   ├─ stdafx.h
</span></span><span class="line"><span class="cl">   └─ stdafx.cpp
</span></span></code></pre></div><h4 id="rtvheaph">RTVHeap.h</h4>
<h5 id="rtvheapクラス">RTVHeapクラス</h5>
<p>ヒープを作成する関数<code>Create()</code>を宣言
<br>▶ 第一引数はデバイスのポインタ
<br>▶ 第二引数は使用個数</p>
<p>レンダーターゲットビューを作成する関数<code>CreateRTV()</code>を宣言
<br>▶ 第一引数はバッファーのポインタ</p>
<p><code>D3D12_CPU_DESCRIPTOR_HANDLE</code>は<strong>CPUディスクリプターハンドル</strong>（CPUからアクセスできるディスクリプタの位置を示すために使用される）について説明する構造体で、リソースやパイプラインステートオブジェクトなどのグラフィックスオブジェクトを参照するために使用されるハンドルを表す
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ns-d3d12-d3d12_cpu_descriptor_handle">詳細</a></p>
<p>レンダーターゲットビューのCPU側アドレスを返す関数<code>GetRTVCPUHandle()</code>を宣言
<br>▶ 第一引数は登録番号</p>
<p><code>ID3D12Device</code>は仮想アタプターを表し、コマンド アロケーター、コマンド リスト、コマンド キュー、フェンス、リソース、パイプライン状態オブジェクト、ヒープ、ルート署名、サンプラー、および多くのリソース ビューを作成するために使用される
<br>DirectX12のアプリケーションでのグラフィックスと計算タスクの中心的なインターフェース
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12device8">詳細</a></p>
<p><code>ID3D12DescriptorHeap</code>はディスクリプタヒープを表すインターフェースで、DirectX 12ではこれを使用してリソースとビューを効率的に管理してレンダリングパイプラインを設定する
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12descriptorheap">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// RTVHeap.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RTVHeap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">Create</span><span class="p">(</span><span class="n">ID3D12Device</span><span class="o">*</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">useCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="nf">CreateRTV</span><span class="p">(</span><span class="n">ID3D12Resource</span><span class="o">*</span> <span class="n">pBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_CPU_DESCRIPTOR_HANDLE</span> <span class="nf">GetRTVCPUHandle</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">ID3D12Device</span><span class="o">*</span> <span class="n">m_pDevice</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12DescriptorHeap</span><span class="o">&gt;</span> <span class="n">m_pHeap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">m_useCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">m_incrementSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">m_nextRegistNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h4 id="rtvheapcpp">RTVHeap.cpp</h4>
<h5 id="rtvheapcreate関数">RTVHeap::Create()関数</h5>
<p><code>D3D12_DESCRIPTOR_HEAP_DESC</code>はディスクリプタヒープについて説明する構造体
<br>▶ <code>heapDesc.Type</code>はヒープ内のディスクリプタの種類を指定
<br>▶ <code>heapDesc.NodeMask</code>は<a href="https://learn.microsoft.com/ja-jp/windows/win32/direct3d12/multi-engine">マルチアダプターシステム</a>への対応（単一アダプター操作の場合は0に設定）
<br>▶ <code>heapDesc.NumDescriptors</code>はヒープ内のディスクリプタの数
<br>▶ <code>heapDesc.Flags</code>はヒープのオプションを指定する（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_descriptor_heap_flags">列挙の詳細</a>）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ns-d3d12-d3d12_descriptor_heap_desc">詳細</a></p>
<p><code>CreateDescriptorHeap()</code>はディスクリプタヒープオブジェクトを作成する関数
<br>▶ 第一引数はヒープを記述する<code>D3D12_DESCRIPTOR_HEAP_DESC</code>構造体へのポインタ
<br>▶ 第二引数はディスクリプタヒープインターフェイスのGUID（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/combaseapi/nf-combaseapi-iid_ppv_args">IID_PPV_ARGSの詳細</a>）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-createdescriptorheap">詳細</a></p>
<p><code>GetDescriptorHandleIncrementSize()</code>は指定された種類のディスクリプタヒープのハンドルインクリメントのサイズを取得する
<br>▶ 第一引数はハンドルインクリメントのサイズを取得するディスクリプタヒープの種類を指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_descriptor_heap_type">列挙の詳細</a>）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-getdescriptorhandleincrementsize">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// RTVHeap.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">RTVHeap</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">ID3D12Device</span><span class="o">*</span> <span class="n">pDevice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">useCount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_DESCRIPTOR_HEAP_DESC</span> <span class="n">heapDesc</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">heapDesc</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">D3D12_DESCRIPTOR_HEAP_TYPE_RTV</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">heapDesc</span><span class="p">.</span><span class="n">NodeMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">heapDesc</span><span class="p">.</span><span class="n">NumDescriptors</span> <span class="o">=</span> <span class="n">useCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">heapDesc</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">D3D12_DESCRIPTOR_HEAP_FLAG_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">CreateDescriptorHeap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heapDesc</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pHeap</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">m_useCount</span> <span class="o">=</span> <span class="n">useCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_incrementSize</span> <span class="o">=</span> <span class="n">pDevice</span><span class="o">-&gt;</span><span class="n">GetDescriptorHandleIncrementSize</span><span class="p">(</span><span class="n">D3D12_DESCRIPTOR_HEAP_TYPE_RTV</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pDevice</span> <span class="o">=</span> <span class="n">pDevice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="rtvheapcreatertv関数">RTVHeap::CreateRTV()関数</h5>
<p><code>GetCPUDescriptorHandleForHeapStart()</code>関数はヒープの開始を表すCPUディスクリプタハンドルを取得する
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12descriptorheap-getcpudescriptorhandleforheapstart">詳細</a></p>
<p><code>D3D12_RENDER_TARGET_VIEW_DESC</code>はレンダーターゲットビューを使用してアクセスできるリソースのサブリソースについてを説明する
<br>▶ <code>rtvDesc.Format</code>は表示形式を指定する<code>DXGI_FORMA</code>型指定された値（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgiformat/ne-dxgiformat-dxgi_format">列挙の詳細</a>）
<br>▶ <code>rtvDesc.ViewDimension</code>はリソースへのアクセス方法を指定する
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ns-d3d12-d3d12_render_target_view_desc">詳細</a></p>
<p><code>CreateRenderTargetView()</code>はリソースデータにアクセスするためのレンダーターゲットビューを作成する
<br>▶ 第一引数はレンダーターゲットを表す<code>ID3D12Resource</code>オブジェクトへのポインタ（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12resource">インターフェースの詳細</a>）
<br>▶ 第二引数はレンダーターゲットビューを記述する<code>D3D12_RENDER_TARGET_VIEW_DESC</code>構造体へのポインタ
<br>▶ 第三引数は新しく作成されたレンダーターゲットビューが存在する宛先を表すCPUディスクリプタハンドル
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-createrendertargetview">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// RTVHeap.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">RTVHeap</span><span class="o">::</span><span class="n">CreateRTV</span><span class="p">(</span><span class="n">ID3D12Resource</span><span class="o">*</span> <span class="n">pBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">m_useCount</span> <span class="o">&lt;</span> <span class="n">m_nextRegistNumber</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;確保済みのヒープ領域を超えました。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_CPU_DESCRIPTOR_HANDLE</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">m_pHeap</span><span class="o">-&gt;</span><span class="n">GetCPUDescriptorHandleForHeapStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">handle</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="n">m_nextRegistNumber</span> <span class="o">*</span> <span class="n">m_incrementSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_RENDER_TARGET_VIEW_DESC</span> <span class="n">rtvDesc</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">	<span class="n">rtvDesc</span><span class="p">.</span><span class="n">Format</span> <span class="o">=</span> <span class="n">DXGI_FORMAT_R8G8B8A8_UNORM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">rtvDesc</span><span class="p">.</span><span class="n">ViewDimension</span> <span class="o">=</span> <span class="n">D3D12_RTV_DIMENSION_TEXTURE2D</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pDevice</span><span class="o">-&gt;</span><span class="n">CreateRenderTargetView</span><span class="p">(</span><span class="n">pBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtvDesc</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">m_nextRegistNumber</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="rtvheapgetrtvcpuhandle関数">RTVHeap::GetRTVCPUHandle()関数</h5>
<p><code>m_pHeap-&gt;GetCPUDescriptorHandleForHeapStart()</code>はヒープの開始を表すCPUディスクリプタハンドルを取得</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// RTVHeap.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">D3D12_CPU_DESCRIPTOR_HANDLE</span> <span class="n">RTVHeap</span><span class="o">::</span><span class="n">GetRTVCPUHandle</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_CPU_DESCRIPTOR_HANDLE</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">m_pHeap</span><span class="o">-&gt;</span><span class="n">GetCPUDescriptorHandleForHeapStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">handle</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="n">m_incrementSize</span> <span class="o">*</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="systemh">System.h</h4>
<p>レンダーターゲットビューの作成に必要な<code>RTVHeap.h</code>をインクルード
<br>※依存関係を考慮して<code>GraphicsDevice.h</code>よりも先にインクルードする</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// System.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Utility/Utility.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;../Graphics/RTVHeap/RTVHeap.h&#34;	// GraphicsDevice.hよりも先にインクルード</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;../Graphics/GraphicsDevice.h&#34;</span><span class="cp">
</span></span></span></code></pre></div><h4 id="graphicsdeviceh-3">GraphicsDevice.h</h4>
<p>RTVHeapの変数とスワップチェーンレンダーターゲットビューの作成関数を追加と、レンダーターゲットビューの作成</p>
<h5 id="graphicsdeviceクラス-3">GraphicsDeviceクラス</h5>
<p>スワップチェーンレンダーターゲットビューを作成する関数<code>CreateSwapchainRTV()</code>を宣言</p>
<p>スマートポインタ<code>unique_ptr</code>を用いてRTVHeapの変数を定義
<br><a href="https://learn.microsoft.com/ja-jp/cpp/cpp/how-to-create-and-use-unique-ptr-instances?view=msvc-170">スマートポインタの詳細</a></p>
<p><code>ID3D12Resource</code>はCPUとGPUの一般化された機能をカプセル化して、物理メモリまたはヒープの読み取りと書き込みを行うインターフェース
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12resource">インターフェースの詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GraphicsDevice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">bool</span> <span class="n">CreateSwapchainRTV</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12Resource</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span>	<span class="n">m_pSwapchainBuffers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">RTVHeap</span><span class="o">&gt;</span>	<span class="n">m_pRTVHeap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="graphicsdevicecpp-3">GraphicsDevice.cpp</h4>
<h5 id="graphicsdeviceinit関数-3">GraphicsDevice::Init()関数</h5>
<p><code>m_pRTVHeap-&gt;Create()</code>を実行</p>
<p><code>CreateSwapchainRTV()</code>を実行</p>
<h5 id="graphicsdevicecreateswapchainrtv関数">GraphicsDevice::CreateSwapchainRTV()関数</h5>
<p><code>m_pSwapChain-&gt;GetBuffer()</code>はスワップチェーンのバックバッファのいずれかにアクセスする関数
<br>▶ 第一引数は0から始まるバッファインデックス
<br>▶ 第二引数はバッファの操作に使用されるインターフェイスの型
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi/nf-dxgi-idxgiswapchain-getbuffer">詳細</a></p>
<p><code>m_pRTVHeap-&gt;CreateRTV()</code>はレンダーターゲットビューを作成する関数
<br>▶ 第一引数はバッファーのポインタ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">m_pRTVHeap</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RTVHeap</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_pRTVHeap</span><span class="o">-&gt;</span><span class="n">Create</span><span class="p">(</span><span class="n">m_pDevice</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;RTVヒープの作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateSwapchainRTV</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;スワップチェーンRTVの作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">CreateSwapchainRTV</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_pSwapchainBuffers</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">auto</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">m_pSwapChain</span><span class="o">-&gt;</span><span class="n">GetBuffer</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pSwapchainBuffers</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">m_pRTVHeap</span><span class="o">-&gt;</span><span class="n">CreateRTV</span><span class="p">(</span><span class="n">m_pSwapchainBuffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="デバッグレイヤーの実装">デバッグレイヤーの実装</h4>
<p>エラー内容を出力するデバッグレイヤーを実装する</p>
<h4 id="graphocsdeviceh">GraphocsDevice.h</h4>
<h5 id="graphicsdeviceクラス-4">GraphicsDeviceクラス</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GraphicsDevice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="n">EnableDebugLayer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="graphicsdevicecpp-4">GraphicsDevice.cpp</h4>
<h5 id="graphicsdeviceinit">GraphicsDevice::Init()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateFactory</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;ファクトリー作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef _DEBUG
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="n">EnableDebugLayer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateDevice</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;D3D12デバイス作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdeviceenabledebuglayer">GraphicsDevice::EnableDebugLayer()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">EnableDebugLayer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ID3D12Debug</span><span class="o">*</span> <span class="n">pDebugLayer</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D3D12GetDebugInterface</span><span class="p">(</span><span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pDebugLayer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">pDebugLayer</span><span class="o">-&gt;</span><span class="n">EnableDebugLayer</span><span class="p">();</span>		<span class="c1">// デバッグレイヤーを有効にする
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDebugLayer</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="バックバッファの描画">バックバッファの描画</h4>
<p>バックバッファはオフスクリーンのメモリ領域で、ダブルバッファリングやトリプルバッファリングといったテクニックを使用して画面のちらつきや遅延を減らすことができる</p>
<h4 id="graphicsdeviceh-4">GraphicsDevice.h</h4>
<h5 id="graphicsdeviceクラス-5">GraphicsDeviceクラス</h5>
<p>画面の切り替えを行う<code>ScreenFlip()</code>関数を宣言</p>
<p>コマンドキューの同期待ちを行う<code>WaitForCommandQueue()</code>関数を宣言</p>
<p>コマンドキューとリソースの同期を管理するFenceの作成を行う<code>CreateFence()</code>関数を宣言</p>
<p>リソースとして引数に渡したバッファの扱いを変更する<code>SetResourceBarrier()</code>関数を宣言
<br>▶ 第一引数は指定バッファ（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12resource">インターフェースの詳細</a>）
<br>▶ 第二引数は現在の状況（<code>D3D12_RESOURCE_STATES</code><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_resource_states">列挙の詳細</a>）
<br>▶ 第三引数は新しい状況（<code>D3D12_RESOURCE_STATES</code><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_resource_states">列挙の詳細</a>）</p>
<p><code>ID3D12Fence</code>はフェンスを表し、CPUと1つ以上のGPUの同期に使用されるオブジェクト
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12fence">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GraphicsDevice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="n">ScreenFlip</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">WaitForCommandQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">bool</span> <span class="n">CreateFence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">SetResourceBarrier</span><span class="p">(</span><span class="n">ID3D12Resource</span><span class="o">*</span> <span class="n">pResource</span><span class="p">,</span> <span class="n">D3D12_RESOURCE_STATES</span> <span class="n">before</span><span class="p">,</span> <span class="n">D3D12_RESOURCE_STATES</span> <span class="n">after</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">ID3D12Fence</span><span class="o">&gt;</span>		<span class="n">m_pFence</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UINT64</span>		<span class="n">m_fenceVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="graphicsdevicecpp-5">GraphicsDevice.cpp</h4>
<h5 id="graphicsdeviceinit-1">GraphicsDevice::Init()</h5>
<p><code>CreateFence()</code>を実行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hWnd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateFence</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;フェンスの作成失敗&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdevicescreenflip">GraphicsDevice::ScreenFlip()</h5>
<h6 id="リソースバリアのステートをレンダーターゲットに変更">リソースバリアのステートをレンダーターゲットに変更</h6>
<p><code>m_pSwapChain-&gt;GetCurrentBackBufferIndex()</code>はスワップチェーンの現在のバックバッファーのインデックスを取得する
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi1_4/nf-dxgi1_4-idxgiswapchain3-getcurrentbackbufferindex">詳細</a></p>
<p><code>SetResourceBarrier()</code>を実行</p>
<h6 id="レンダーターゲットをセット">レンダーターゲットをセット</h6>
<p><code>m_pRTVHeap-&gt;GetRTVCPUHandle()</code>を実行</p>
<p><code>m_pCmdList-&gt;OMSetRenderTargets()</code>はレンダーターゲットと深度ステンシルのCPUディスクリプタハンドルを設定する
<br>▶ 第一引数は<code>rtvH</code>配列内のエントリの数
<br>▶ 第二引数はレンダーターゲットディスクリプタのヒープの開始を表すCPUディスクリプタハンドルを記述する<code>D3D12_CPU_DESCRIPTOR_HANDLE</code>構造体の配列を指定
<br>▶ 第三引数について、<code>False</code>はハンドルが第一引数のハンドルの配列の最初であることを意味する
<br>▶ 第四引数は深度ステンシルディスクリプタを保持するヒープの開始を表すCPUディスクリプタハンドル
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12graphicscommandlist-omsetrendertargets">詳細</a></p>
<h6 id="セットしたレンダーターゲットの画面をクリア">セットしたレンダーターゲットの画面をクリア</h6>
<p><code>m_pCmdList-&gt;ClearRenderTargetView()</code>はレンダーターゲット内のすべての要素を1つの値に設定する
<br>▶ 第一引数はレンダーターゲットがクリアされるヒープの開始を表すCPUディスクリプタハンドルを記述
<br>▶ 第二引数は塗りつぶす色を表す4成分配列
<br>▶ 第三引数は第四引数のパラメーターが指定する配列内の四角形の数を指定
<br>▶ 第四引数はリソースビューでクリアする四角形の<code>D3D12_RECT</code>構造体の配列を指定し、NULLの場合はリソースビュー全体をクリアする
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12graphicscommandlist-clearrendertargetview">詳細</a></p>
<h6 id="リソースバリアのステートをプレゼントに戻す">リソースバリアのステートをプレゼントに戻す</h6>
<p><code>SetResourceBarrier()</code>を実行</p>
<h6 id="コマンドリストを閉じて実行">コマンドリストを閉じて実行</h6>
<p><code>m_pCmdList-&gt;Close()</code>はコマンドリストへの記録が完了したことを示す
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12graphicscommandlist-close">詳細</a></p>
<p><code>ID3D12CommandList</code>はGPUが実行するコマンドの順序付きセットを表すインタフェース
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nn-d3d12-id3d12commandlist">詳細</a></p>
<p><code>m_pCmdQueue-&gt;ExecuteCommandLists()</code>は実行するコマンドリストの配列を送信する
<br>▶ 第一引数は実行するコマンドの数
<br>▶ 第二引数は実行する<code>ID3D12CommandList</code>コマンドリストの配列
<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists">詳細</a></p>
<h6 id="コマンドリストの同期を待つ">コマンドリストの同期を待つ</h6>
<p><code>WaitForCommandQueue()</code>を実行</p>
<h6 id="コマンドアロケータとコマンドリストを初期化">コマンドアロケータとコマンドリストを初期化</h6>
<p><code>m_pCmdAllocator-&gt;Reset()</code>はコマンドアロケーターに関連付けられているメモリを再利用することを示す</p>
<p><code>m_pCmdList-&gt;Reset()</code>は新しいコマンドリストが作成されたかのように、コマンドリストを初期状態に戻す</p>
<h6 id="スワップチェーンにプレゼント">スワップチェーンにプレゼント</h6>
<p><code>m_pSwapChain-&gt;Present()</code>はレンダリングされたイメージをユーザーに表示する
<br>▶ 第一引数はフレームのプレゼンテーションを垂直空白と同期する方法を指定する整数値
<br>▶ 第二引数はスワップチェーンプレゼンテーションオプションを含む整数値
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/dxgi/nf-dxgi-idxgiswapchain-present">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">ScreenFlip</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">bbIdx</span> <span class="o">=</span> <span class="n">m_pSwapChain</span><span class="o">-&gt;</span><span class="n">GetCurrentBackBufferIndex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetResourceBarrier</span><span class="p">(</span><span class="n">m_pSwapchainBuffers</span><span class="p">[</span><span class="n">bbIdx</span><span class="p">].</span><span class="n">Get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="n">D3D12_RESOURCE_STATE_PRESENT</span><span class="p">,</span> <span class="n">D3D12_RESOURCE_STATE_RENDER_TARGET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">rtvH</span> <span class="o">=</span> <span class="n">m_pRTVHeap</span><span class="o">-&gt;</span><span class="n">GetRTVCPUHandle</span><span class="p">(</span><span class="n">bbIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdList</span><span class="o">-&gt;</span><span class="n">OMSetRenderTargets</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtvH</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">float</span> <span class="n">clearColor</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">,</span> <span class="mf">1.0f</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdList</span><span class="o">-&gt;</span><span class="n">ClearRenderTargetView</span><span class="p">(</span><span class="n">rtvH</span><span class="p">,</span> <span class="n">clearColor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">SetResourceBarrier</span><span class="p">(</span><span class="n">m_pSwapchainBuffers</span><span class="p">[</span><span class="n">bbIdx</span><span class="p">].</span><span class="n">Get</span><span class="p">(),</span> <span class="n">D3D12_RESOURCE_STATE_RENDER_TARGET</span><span class="p">,</span> <span class="n">D3D12_RESOURCE_STATE_PRESENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdList</span><span class="o">-&gt;</span><span class="n">Close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ID3D12CommandList</span><span class="o">*</span> <span class="n">cmdlists</span><span class="p">[]{</span> <span class="n">m_pCmdList</span><span class="p">.</span><span class="n">Get</span><span class="p">()</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdQueue</span><span class="o">-&gt;</span><span class="n">ExecuteCommandLists</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmdlists</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">WaitForCommandQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdAllocator</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdList</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">(</span><span class="n">m_pCmdAllocator</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">m_pSwapChain</span><span class="o">-&gt;</span><span class="n">Present</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdevicewaitforcommandqueue">GraphicsDevice::WaitForCommandQueue()</h5>
<p><code>m_pCmdQueue-&gt;Signal()</code>は指定した値にフェンスを更新する
<br>▶ 第一引数は<code>ID3D12Fence</code>オブジェクトへのポインタ
<br>▶ 第二引数はフェンスを設定する値を指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12commandqueue-signal">詳細</a></p>
<p><code>m_pFence-&gt;GetCompletedValue()</code>はフェンスの現在の値を取得する
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12fence-getcompletedvalue">詳細</a></p>
<p><code>CreateEvent()</code>はイベントハンドルを取得する</p>
<p><code>m_pFence-&gt;SetEventOnCompletion()</code>はフェンスが特定の値に達したときに発生するイベントを指定する
<br>▶ 第一引数はイベントが通知される場合のフェンス値を指定
<br>▶ 第二引数はイベントオブジェクトへのハンドルを指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12fence-seteventoncompletion">詳細</a></p>
<p><code>WaitForSingleObject()</code>は指定したオブジェクトがシグナル状態であるか、タイムアウト間隔が経過するまで待機してイベントが発生するまで待つ
<br>▶ 第一引数はオブジェクトへのハンドルを指定
<br>▶ 第二引数はタイムアウト間隔(ミリ秒単位)を指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">詳細</a></p>
<p><code>CloseHandle()</code>は開いているオブジェクトハンドルを閉じる
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/handleapi/nf-handleapi-closehandle">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">WaitForCommandQueue</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdQueue</span><span class="o">-&gt;</span><span class="n">Signal</span><span class="p">(</span><span class="n">m_pFence</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="o">++</span><span class="n">m_fenceVal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">m_pFence</span><span class="o">-&gt;</span><span class="n">GetCompletedValue</span><span class="p">()</span> <span class="o">!=</span> <span class="n">m_fenceVal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">auto</span> <span class="n">event</span> <span class="o">=</span> <span class="n">CreateEvent</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>		<span class="c1">// イベントハンドルの取得
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;イベントエラー、アプリケーションを終了します&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_pFence</span><span class="o">-&gt;</span><span class="n">SetEventOnCompletion</span><span class="p">(</span><span class="n">m_fenceVal</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>		<span class="c1">// イベントが発生するまで待ち続ける
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>							<span class="c1">// イベントハンドルを閉じる
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdevicecreatefence">GraphicsDevice::CreateFence()</h5>
<p><code>m_pDevice-&gt;CreateFence()</code>はフェンスオブジェクトを作成する
<br>▶ 第一引数はフェンスの初期値を指定
<br>▶ 第二引数はフェンスのオプションを指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_fence_flags">列挙の詳細</a>）
<br>▶ 第三引数はフェンスインターフェイス<code>ID3D12Fence</code>のGUIDを指定
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12device-createfence">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">CreateFence</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">m_pDevice</span><span class="o">-&gt;</span><span class="n">CreateFence</span><span class="p">(</span><span class="n">m_fenceVal</span><span class="p">,</span> <span class="n">D3D12_FENCE_FLAG_NONE</span><span class="p">,</span> <span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_pFence</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="graphicsdevicesetresourcebarrier">GraphicsDevice::SetResourceBarrier()</h5>
<p><code>D3D12_RESOURCE_BARRIER</code>はリソースバリア(リソース使用の遷移)について説明する構造体
<br>▶ <code>barrier.Transition</code>はサブリソースの使用の前後を指定する（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ns-d3d12-d3d12_resource_transition_barrier">構造体の詳細</a>）
<br>▶ <code>barrier.Transition.pResource</code>は遷移で使用されるリソースを表す<code>ID3D12Resource</code>オブジェクトへのポインタを指定
<br>▶ <code>barrier.Transition.StateAfter</code>はサブリソースの&quot;after&quot;使用法指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_resource_states">列挙の詳細</a>）
<br>▶ <code>barrier.Transition.StateBefore</code>はサブリソースの&quot;before&quot;使用法を指定（<a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ne-d3d12-d3d12_resource_states">列挙の詳細</a>）
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/ns-d3d12-d3d12_resource_barrier">詳細</a></p>
<p><code>m_pCmdList-&gt;ResourceBarrier()</code>はリソースへの複数のアクセスを同期する必要があることをドライバーに通知する
<br><a href="https://learn.microsoft.com/ja-jp/windows/win32/api/d3d12/nf-d3d12-id3d12graphicscommandlist-resourcebarrier">詳細</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// GraphicsDevice.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">SetResourceBarrier</span><span class="p">(</span><span class="n">ID3D12Resource</span><span class="o">*</span> <span class="n">pResource</span><span class="p">,</span> <span class="n">D3D12_RESOURCE_STATES</span> <span class="n">before</span><span class="p">,</span> <span class="n">D3D12_RESOURCE_STATES</span> <span class="n">after</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">D3D12_RESOURCE_BARRIER</span> <span class="n">barrier</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">	<span class="n">barrier</span><span class="p">.</span><span class="n">Transition</span><span class="p">.</span><span class="n">pResource</span> <span class="o">=</span> <span class="n">pResource</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">barrier</span><span class="p">.</span><span class="n">Transition</span><span class="p">.</span><span class="n">StateAfter</span> <span class="o">=</span> <span class="n">after</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">barrier</span><span class="p">.</span><span class="n">Transition</span><span class="p">.</span><span class="n">StateBefore</span> <span class="o">=</span> <span class="n">before</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">m_pCmdList</span><span class="o">-&gt;</span><span class="n">ResourceBarrier</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">barrier</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="applicationcpp-1">Application.cpp</h4>
<h5 id="applicationexecute">Application::Execute()</h5>
<p>while文の中で<code>GraphicsDevice::Instance().ScreenFlip()</code>を実行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Application.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Application</span><span class="o">::</span><span class="n">Execute</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ~ //
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">GraphicsDevice</span><span class="o">::</span><span class="n">Instance</span><span class="p">().</span><span class="n">ScreenFlip</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/nishihi6" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://www.facebook.com/profile.php?id=100034856812491" target="_blank" rel="noopener noreferrer me"
    title="Facebook">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg>
</a>
<a href="https://twitter.com" target="_blank" rel="noopener noreferrer me"
    title="X">
    <svg viewBox="0 0 1200 1227" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path
        d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
</svg>
</a>
<a href="https://connpass.com/user/nishihi6/" target="_blank" rel="noopener noreferrer me"
    title="Connpass">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
</a>
<a href="http://www.igl.ise.shibaura-it.ac.jp/" target="_blank" rel="noopener noreferrer me"
    title="Lab">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
</a>
<a href="index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2023 nishihi6.
    </small>
    
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script src="https://nishihi6.github.io/blog/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js" integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30&#43;lSNuSkl4QXuNyy8="></script>

    

</body>
</html>
