<!DOCTYPE html>
<html lang="ja-jp"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025] | nishihi6</title>
<meta property="og:title" content="GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025] | nishihi6" />
<meta name="twitter:title" content="GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025] | nishihi6" />
<meta itemprop="name" content="GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025] | nishihi6" />
<meta name="application-name" content="GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025] | nishihi6" />
<meta property="og:site_name" content="nishihi6" />

<meta name="description" content="Minimal Hugo blog theme with light and dark mode support">
<meta itemprop="description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta property="og:description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta name="twitter:description" content="Minimal Hugo blog theme with light and dark mode support" />

<meta property="og:locale" content="ja-jp" />
<meta name="language" content="ja-jp" />



  <meta itemprop="image" content="https://nishihi6.github.io/blog/" />
  <meta property="og:image" content="https://nishihi6.github.io/blog/" />
  <meta name="twitter:image" content="https://nishihi6.github.io/blog/" />
  <meta name="twitter:image:src" content="https://nishihi6.github.io/blog/" />




    
    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2024-01-29T03:15:04&#43;0900 />
    <meta property="article:published_time" content=2024-01-29T03:15:04&#43;0900 />

    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025]",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2024-01-29",
        "description": "",
        "wordCount":  756 ,
        "mainEntityOfPage": "True",
        "dateModified": "2024-01-29",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "nishihi6"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.117.0">

    

    <link rel="canonical" href="https://nishihi6.github.io/blog/posts/devlog_gl_09/">
    <link href="/blog/style.min.840eada6dfddec7b8ccfcf867f039bf80b1f16a265ec6e01dc553a3dddc9d509.css" rel="stylesheet">
    <link href="/blog/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/blog/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/blog/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/blog/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/blog/favicon.ico">




<link rel="manifest" href="https://nishihi6.github.io/blog/site.webmanifest">

<meta name="msapplication-config" content="/blog/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/blog/icons/favicon.svg">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous" />


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
    crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ]
    });"></script>

    </head>
<body data-theme = "dark" class="notransition">

<script src="/blog/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="https://nishihi6.github.io/blog/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/blog/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/blog/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/blog/pages/about/">
                        About
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">GameDev #9 カメラ（FPS・追従・軌道・スプライン） [Devlog #025]</h1>
                
                
                <div class="post-meta">
                    <time datetime="2024-01-29T03:15:04&#43;09:00" itemprop="datePublished"> 29 Jan 2024 </time>
                </div>
                
            </header>
            <details class="toc">
                <summary><b>Table of Contents</b></summary>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#カメラ">カメラ</a>
      <ul>
        <li><a href="#fpsカメラ">FPSカメラ</a>
          <ul>
            <li><a href="#基本的な一人称の動き">基本的な一人称の動き</a></li>
            <li><a href="#カメラピッチなし">カメラ（ピッチなし）</a></li>
            <li><a href="#ピッチ横向きの軸での回転を加える">ピッチ（横向きの軸での回転）を加える</a></li>
            <li><a href="#一人称モデル">一人称モデル</a></li>
          </ul>
        </li>
        <li><a href="#追従カメラ">追従カメラ</a>
          <ul>
            <li><a href="#基本的な追従カメラ">基本的な追従カメラ</a></li>
            <li><a href="#ばねを追加する">ばねを追加する</a></li>
          </ul>
        </li>
        <li><a href="#軌道カメラ">軌道カメラ</a>
          <ul>
            <li><a href="#基本的な軌道カメラ">基本的な軌道カメラ</a></li>
          </ul>
        </li>
        <li><a href="#スプラインカメラ">スプラインカメラ</a>
          <ul>
            <li><a href="#基本的なスプラインカメラ">基本的なスプラインカメラ</a></li>
          </ul>
        </li>
        <li><a href="#逆射影">逆射影</a>
          <ul>
            <li><a href="#逆射影の基本">逆射影の基本</a></li>
          </ul>
        </li>
        <li><a href="#ゲームプロジェクト">ゲームプロジェクト</a>
          <ul>
            <li><a href="#確認">確認</a></li>
          </ul>
        </li>
        <li><a href="#まとめ">まとめ</a>
          <ul>
            <li><a href="#参考文献">参考文献</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
            </details><div class="page-content">
                <p>ゲーム開発者の教科書：<a href="https://www.shoeisha.co.jp/book/detail/9784798157610">Game Programming in C++</a> を読んで理解したことについてを要約します（内容の転載を避け、詳しく説明しすぎないように配慮します）</p>
<h1 id="ゲームプログラミング-in-c">ゲームプログラミング in C++</h1>
<hr>
<h2 id="カメラ">カメラ</h2>
<p>ここでは、4種類の<strong>カメラの実装</strong>を行う（FPSカメラ、追従カメラ、軌道カメラ、スプラインカメラ）</p>
<h3 id="fpsカメラ">FPSカメラ</h3>
<p><strong>FPSカメラ</strong>（first-person camera）は、キャラクターの視点から映すようなカメラである</p>
<p>PCの一人称シューターでは、キーボードとマウスを使う操作が一般的であり、WとSキーで前進と後退、AキーとDキーで左右移動（ストレイフ）、マウスの動きに合わせてビューがピッチングする</p>
<h4 id="基本的な一人称の動き">基本的な一人称の動き</h4>
<p>キャラクターを動かす</p>
<h5 id="actorh">Actor.h</h5>
<p>左右移動のため、右方ベクトルを取得する<code>GetRight()</code>を追加する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">Vector3</span> <span class="nf">GetRight</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Vector3</span><span class="o">::</span><span class="n">Transform</span><span class="p">(</span><span class="n">Vector3</span><span class="o">::</span><span class="n">UnitY</span><span class="p">,</span> <span class="n">mRotation</span><span class="p">);</span> <span class="p">}</span>
</span></span></code></pre></div><h5 id="movecomponenth">MoveComponent.h</h5>
<p>左右移動の速さを表すメンバ変数<code>mStrafeSpeed</code>を追加する</p>
<p>ゲッターとセッターを追加する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">GetAngularSpeed</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">mAngularSpeed</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">GetForwardSpeed</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">mForwardSpeed</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">GetStrafeSpeed</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">mStrafeSpeed</span><span class="p">;</span> <span class="p">}</span>	<span class="c1">//※
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">SetAngularSpeed</span><span class="p">(</span><span class="kt">float</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span> <span class="n">mAngularSpeed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">SetForwardSpeed</span><span class="p">(</span><span class="kt">float</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span> <span class="n">mForwardSpeed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">SetStrafeSpeed</span><span class="p">(</span><span class="kt">float</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span> <span class="n">mStrafeSpeed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span> <span class="p">}</span>	<span class="c1">//※
</span></span></span></code></pre></div><h5 id="movecomponentcpp">MoveComponent.cpp</h5>
<h5 id="movecomponentupdate">MoveComponent::Update()</h5>
<p><code>mStrafeSpeed</code>をもとに右方ベクトルで位置を調整する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Math</span><span class="o">::</span><span class="n">NearZero</span><span class="p">(</span><span class="n">mForwardSpeed</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">Math</span><span class="o">::</span><span class="n">NearZero</span><span class="p">(</span><span class="n">mStrafeSpeed</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Vector3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">GetPosition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">pos</span> <span class="o">+=</span> <span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">GetForward</span><span class="p">()</span> <span class="o">*</span> <span class="n">mForwardSpeed</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pos</span> <span class="o">+=</span> <span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">GetRight</span><span class="p">()</span> <span class="o">*</span> <span class="n">mStrafeSpeed</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><h5 id="fpsactorcpp">FPSActor.cpp</h5>
<h5 id="fpsactoractorinput">FPSActor::ActorInput()</h5>
<p>AキーとDキーを監視して左右移動の速度を調整する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">forwardSpeed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">strafeSpeed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// wasd movement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">SDL_SCANCODE_W</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">forwardSpeed</span> <span class="o">+=</span> <span class="mf">400.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">SDL_SCANCODE_S</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">forwardSpeed</span> <span class="o">-=</span> <span class="mf">400.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">SDL_SCANCODE_A</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">strafeSpeed</span> <span class="o">-=</span> <span class="mf">400.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">SDL_SCANCODE_D</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">strafeSpeed</span> <span class="o">+=</span> <span class="mf">400.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mMoveComp</span><span class="o">-&gt;</span><span class="n">SetForwardSpeed</span><span class="p">(</span><span class="n">forwardSpeed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">mMoveComp</span><span class="o">-&gt;</span><span class="n">SetStrafeSpeed</span><span class="p">(</span><span class="n">strafeSpeed</span><span class="p">);</span>
</span></span></code></pre></div><h5 id="gamecpp">Game.cpp</h5>
<h5 id="gameloaddata">Game::LoadData()</h5>
<p>マウスの相対運動モードを有効にする</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Enable relative mouse mode for camera look
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SDL_SetRelativeMouseMode</span><span class="p">(</span><span class="n">SDL_TRUE</span><span class="p">);</span>
</span></span></code></pre></div><h5 id="fpsactorcpp-1">FPSActor.cpp</h5>
<h5 id="fpsactoractorinput-1">FPSActor::ActorInput()</h5>
<p><code>SDL_GetRelativeMouseState()</code>で移動量$(x,y)$を取得する</p>
<p>1フレームでの最大移動量<code>maxMouseSpeed</code>を設定する（ユーザー定義でもよい）</p>
<p>最大移動量での角速度<code>maxAngularSpeed</code>を設定し、角速度<code>angularSpeed</code>を<code>MoveComponent</code>に送る</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Mouse movement
</span></span></span><span class="line"><span class="cl"><span class="c1">// Get relative movement from SDL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">SDL_GetRelativeMouseState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Assume mouse movement is usually between -500 and +500
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">int</span> <span class="n">maxMouseSpeed</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Rotation/sec at maximum speed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">float</span> <span class="n">maxAngularSpeed</span> <span class="o">=</span> <span class="n">Math</span><span class="o">::</span><span class="n">Pi</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">angularSpeed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Convert to ~[-1.0, 1.0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">angularSpeed</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxMouseSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Multiply by rotation/sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">angularSpeed</span> <span class="o">*=</span> <span class="n">maxAngularSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">mMoveComp</span><span class="o">-&gt;</span><span class="n">SetAngularSpeed</span><span class="p">(</span><span class="n">angularSpeed</span><span class="p">);</span>
</span></span></code></pre></div><h4 id="カメラピッチなし">カメラ（ピッチなし）</h4>
<p><code>Component</code>派生クラス<code>CameraComponent</code>を作る</p>
<p>4種類のカメラはこの<code>CameraComponent</code>を派生する</p>
<h5 id="cameracomponenth">CameraComponent.h</h5>
<p>ビュー行列をレンダラとオーディオシステムに送るprotected関数<code>SetViewMatrix()</code>を追加する</p>
<h5 id="cameracomponentcpp">CameraComponent.cpp</h5>
<h5 id="cameracomponentsetviewmatrix">CameraComponent::SetViewMatrix()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Pass view matrix to renderer and audio system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Game</span><span class="o">*</span> <span class="n">game</span> <span class="o">=</span> <span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">GetGame</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">game</span><span class="o">-&gt;</span><span class="n">GetRenderer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetViewMatrix</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">game</span><span class="o">-&gt;</span><span class="n">GetAudioSystem</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetListener</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
</span></span></code></pre></div><h5 id="fpscameracpp">FPSCamera.cpp</h5>
<p><code>CameraComponent</code>の派生クラス</p>
<h5 id="fpscameraupdate">FPSCamera::Update()</h5>
<p><code>Update()</code>をオーバーライドする</p>
<p>カメラの位置は、所有者であるアクターの位置
<br>ターゲットポイントは、所有アクターの前方に位置する点
<br>上方ベクトルは$z$軸とする</p>
<p><code>Matrix4::CreateLookAt()</code>でビュー行列を作る</p>
<h4 id="ピッチ横向きの軸での回転を加える">ピッチ（横向きの軸での回転）を加える</h4>
<h5 id="fpscamerah">FPSCamera.h</h5>
<p>新しいメンバ変数を追加する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Rotation/sec speed of pitch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">mPitchSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Maximum pitch deviation from forward
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">mMaxPitch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Current pitch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">mPitch</span><span class="p">;</span>
</span></span></code></pre></div><p>上下にピッチできる量に制限<code>mMaxPitch</code>を加えることで、仰向けになったときの制御の不具合を防ぐ</p>
<h5 id="fpscameracpp-1">FPSCamera.cpp</h5>
<h5 id="fpscameraupdate-1">FPSCamera::Update()</h5>
<p>現在のピッチの値を、ピッチのスピードとデルタタイムに基づいて更新する</p>
<p>ピッチの量が最大ピッチ（+/-）を超えないようにクランプする</p>
<p>ピッチを表現するクォータニオンを作る（所有アクターの右向きの軸を中心とする（ピッチの軸が所有者のヨーに依存している））</p>
<p>所有者の前方ベクトルをピッチのクォータニオンで変換して前方への視線<code>viewForward</code>を作る</p>
<p>注視行列<code>view</code>を作成し、ビューに設定する</p>
<h5 id="fpsactorcpp-2">FPSActor.cpp</h5>
<h5 id="ffpsactoractorinput">FFPSActor::ActorInput()</h5>
<p>ピッチのスピードを<code>FPSCamera</code>（CameraComponent派生クラス）に送る</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Compute pitch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">float</span> <span class="n">maxPitchSpeed</span> <span class="o">=</span> <span class="n">Math</span><span class="o">::</span><span class="n">Pi</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">pitchSpeed</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Convert to ~[-1.0, 1.0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pitchSpeed</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxMouseSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pitchSpeed</span> <span class="o">*=</span> <span class="n">maxPitchSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">mCameraComp</span><span class="o">-&gt;</span><span class="n">SetPitchSpeed</span><span class="p">(</span><span class="n">pitchSpeed</span><span class="p">);</span>
</span></span></code></pre></div><h4 id="一人称モデル">一人称モデル</h4>
<h5 id="fpsactorcpp-3">FPSActor.cpp</h5>
<h5 id="fpsactorupdateactor">FPSActor::UpdateActor()</h5>
<p>モデルがアニメーションするパーツ（腕や脚や武器）を持つことを考慮し、フレームごとに位置と回転を更新する</p>
<p>一人称モデルの位置は、<code>FPSActor</code>の位置にオフセットを加えたもの</p>
<p>回転は、<code>FPSActor</code>の回転にビューのピッチの回転を追加する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Update position of FPS model relative to actor position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="n">Vector3</span> <span class="nf">modelOffset</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="mf">10.0f</span><span class="p">,</span> <span class="mf">10.0f</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0f</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">Vector3</span> <span class="n">modelPos</span> <span class="o">=</span> <span class="n">GetPosition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">modelPos</span> <span class="o">+=</span> <span class="n">GetForward</span><span class="p">()</span> <span class="o">*</span> <span class="n">modelOffset</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">modelPos</span> <span class="o">+=</span> <span class="n">GetRight</span><span class="p">()</span> <span class="o">*</span> <span class="n">modelOffset</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">modelPos</span><span class="p">.</span><span class="n">z</span> <span class="o">+=</span> <span class="n">modelOffset</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">mFPSModel</span><span class="o">-&gt;</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">modelPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Initialize rotation to actor rotation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Quaternion</span> <span class="n">q</span> <span class="o">=</span> <span class="n">GetRotation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Rotate by pitch from camera
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">q</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="o">::</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">GetRight</span><span class="p">(),</span> <span class="n">mCameraComp</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl"><span class="n">mFPSModel</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span></span></code></pre></div><h3 id="追従カメラ">追従カメラ</h3>
<p><strong>追従カメラ</strong>（follow camera）は、ターゲットオブジェクトを後方から追いかけるカメラである</p>
<h4 id="基本的な追従カメラ">基本的な追従カメラ</h4>
<p>基本的な追従カメラは、所有アクターを上後方から常に決まった距離で追いかける</p>
<p>車を追いかける追従カメラを例とすると、カメラは車の後方に水平距離で$HDist$、上方に垂直距離で$VDist$の位置に固定する</p>
<p>カメラの注視点は、車より$TargetDist$先の点とする</p>
<p>カメラの位置：
$$
CameraPos = OwnerPos - OwnerForward\cdot HDist + OwnerUp\cdot VDist
$$
注視点：
$$
TargetPos = OwnerPos + OwnerForward\cdot TargetDist
$$</p>
<h5 id="followcamerah">FollowCamera.h</h5>
<p><code>CameraComponent</code>の派生クラス</p>
<p>水平距離<code>CameraComponent</code>、垂直距離<code>mVertDist</code>、ターゲット距離<code>mTargetDist</code>のメンバ変数を追加する</p>
<h5 id="followcameracomputecamerapos">FollowCamera::ComputeCameraPos()</h5>
<p>カメラの位置を計算する</p>
<h5 id="followcameraupdate">FollowCamera::Update()</h5>
<p>カメラ位置と注視点を使ったビュー行列を作る</p>
<h4 id="ばねを追加する">ばねを追加する</h4>
<p>カメラの位置を&quot;理想&quot;のポジションと&quot;実際&quot;のポジションに分け、ばねで連結する</p>
<h5 id="followcamerah-1">FollowCamera.h</h5>
<p>メンバ変数<code>mSpringConstant</code>は、ばねの硬さを表現する</p>
<p>カメラの実際の位置<code>mActualPos</code>と速度<code>mVelocity</code>を追加する</p>
<h5 id="followcameracpp">FollowCamera.cpp</h5>
<h5 id="followcameraupdate-1">FollowCamera::Update()</h5>
<p>ばね定数<code>mSpringConstant</code>から、ばねの減衰<code>dampening</code>を計算する</p>
<p>&ldquo;実際の位置と理想の位置との差&quot;と&quot;前フレームの速度&quot;から、カメラの加速度を計算する</p>
<p>注視点の計算は元のままで、<code>CreateLookAt()</code>では実際のカメラポジション<code>mActualPos</code>を使う</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CameraComponent</span><span class="o">::</span><span class="n">Update</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Compute dampening from spring constant
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">dampening</span> <span class="o">=</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="n">Math</span><span class="o">::</span><span class="n">Sqrt</span><span class="p">(</span><span class="n">mSpringConstant</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Compute ideal position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Vector3</span> <span class="n">idealPos</span> <span class="o">=</span> <span class="n">ComputeCameraPos</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Compute difference between actual and ideal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Vector3</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">mActualPos</span> <span class="o">-</span> <span class="n">idealPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Compute acceleration of spring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Vector3</span> <span class="n">acel</span> <span class="o">=</span> <span class="o">-</span><span class="n">mSpringConstant</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">dampening</span> <span class="o">*</span> <span class="n">mVelocity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Update velocity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mVelocity</span> <span class="o">+=</span> <span class="n">acel</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Update actual camera position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mActualPos</span> <span class="o">+=</span> <span class="n">mVelocity</span> <span class="o">*</span> <span class="n">deltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Target is target dist in front of owning actor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Vector3</span> <span class="n">target</span> <span class="o">=</span> <span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">GetPosition</span><span class="p">()</span> <span class="o">+</span> <span class="n">mOwner</span><span class="o">-&gt;</span><span class="n">GetForward</span><span class="p">()</span> <span class="o">*</span> <span class="n">mTargetDist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Use actual position here, not ideal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Matrix4</span> <span class="n">view</span> <span class="o">=</span> <span class="n">Matrix4</span><span class="o">::</span><span class="n">CreateLookAt</span><span class="p">(</span><span class="n">mActualPos</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">Vector3</span><span class="o">::</span><span class="n">UnitZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">SetViewMatrix</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
</span></span></code></pre></div><h5 id="followcamerasnaptoideal">FollowCamera::SnapToIdeal()</h5>
<p>カメラがゲームの開始時点で正しく動くように、<code>SnapToIdeal()</code>を<code>FollowActor()</code>の初期化時に呼び出す</p>
<h3 id="軌道カメラ">軌道カメラ</h3>
<p><strong>軌道カメラ</strong>（orbit camera）は、ターゲットを中心として、その周りを回るカメラである</p>
<h4 id="基本的な軌道カメラ">基本的な軌道カメラ</h4>
<p>軌道を回るヨーとピッチの両方をマウスで操作する</p>
<p>カメラは、右マウスボタンを押している時だけ回転する</p>
<h5 id="orbitcamerah">OrbitCamera.h</h5>
<p>ターゲットからのオフセット<code>offset</code>、カメラの上方ベクトル<code>mUp</code>、ピッチの角速度<code>mPitchSpeed</code>、ヨーの角速度<code>mYawSpeed</code>のメンバ変数を追加する</p>
<p>マウスによる回転操作に応じて、角速度<code>mPitchSpeed</code>と<code>mYawSpeed</code>を更新する</p>
<p>カメラの回転に応じて、上方ベクトル<code>mUp</code>を更新する必要がある（常に$(0,0,1)$ではない）</p>
<h5 id="orbitcameracpp">OrbitCamera.cpp</h5>
<p>コンストラクタで、<code>mPitchSpeed</code>と<code>mYawSpeed</code>を0で初期化し、<code>mOffset</code>の初期値は任意で後方400単位、<code>mUp</code>はワールド空間の上方$(0,0,1)$で初期化する</p>
<h5 id="orbitcameraupdate">OrbitCamera::Update()</h5>
<p>ヨーの回転（ワールドの上方を軸とする）クォータニオン<code>yaw</code>を作る</p>
<p><code>yaw</code>でカメラのオフセット<code>mOffset</code>と上方ベクトル<code>mUp</code>を変換する</p>
<p>カメラの前方ベクトル<code>forward</code>を新しいオフセットから求める</p>
<p>カメラの右方ベクトル<code>right</code>を、カメラの上方と前方のクロス積で求める</p>
<p>ピッチのクォータニオン<code>pitch</code>を作成し、再度オフセット<code>mOffset</code>と上方ベクトル<code>mUp</code>を変換する</p>
<p>注視行列においては、カメラの注視点は所有アクターの位置、カメラポジションは注視点にオフセットを足したもの、上方はカメラの上方とする</p>
<h3 id="スプラインカメラ">スプラインカメラ</h3>
<p><strong>スプラインカメラ</strong>（spline camera）は、曲線上の点列で指定される</p>
<p>プレイヤーがゲームワールドを進む時、その道筋をカメラが追従するようにする用途に使われる</p>
<h4 id="基本的なスプラインカメラ">基本的なスプラインカメラ</h4>
<p><strong>Catmull-Rom</strong>スプラインは、比較的計算が単純なスプライン曲線で、最小で4つの制御点が必要がある</p>
<p>4つの制御点がある時、$P_1$から$P_2$までの位置は、以下のパラメトリック方程式（parametric equation）で表現できる</p>
<p>$$
p(t) = 0.5\cdot (2P_1 + (-P_0 + P_2)t + (2P_0 - 5P_1 + 4P_2 - P_3)t^2 + (-P_0 + 3P_1 - 3P_2 + P_3)t^3)
$$</p>
<p>$n$個の点を通るカーブを表現するのに、$n+2$個の制御点が必要になる</p>
<h5 id="sprinecamerah">SprineCamera.h</h5>
<p>スプラインを定義する<code>Spline</code>構造体は、制御点の配列<code>mControlPoints</code>をメンバデータとする</p>
<h5 id="splinecompute">Spline::Compute()</h5>
<p>スプライン方程式の関数</p>
<p>引数の<code>startIdx</code>は$P_1$に対応し、引数の<code>t</code>は$[0.0, 1.0]$の範囲とする</p>
<h5 id="splinecamerasplinecamera">SplineCamera::SplineCamera()</h5>
<p>スプライン<code>mPath</code>、$P_1$に対応する現在のインデックス<code>mIndex</code>、現在の$t$の値<code>mT</code>、スピード<code>mSpeed</code>、カメラを経路に沿って動かすかどうか<code>mPaused</code>のメンバを管理する</p>
<h5 id="splinecameraupdate">SplineCamera::Update()</h5>
<p>$t$の値を、スピードとデルタタイムの積だけ増やす</p>
<p>$t$の値が1.0以上であれば、$P_1$は経路の次の点に進む（進む際は$t$の値から1.0を引く）</p>
<p>もし十分な数の点がなければ、スプラインカメラは停止する</p>
<h3 id="逆射影">逆射影</h3>
<p>スクリーン空間の<strong>座標</strong>からワールド空間の<strong>座標</strong>に変換する計算を<strong>逆射影</strong>（unprojection）と呼ぶ</p>
<p>FPSシューターの例では、スクリーン上の標準レティクルに沿って弾丸を発射する場合、狙いどおりに反射するにはスクリーン空間の座標ではなく、ワールド空間の座標が必要となる</p>
<h4 id="逆射影の基本">逆射影の基本</h4>
<p>スクリーン空間の座標の$x$と$y$の両方の成分をデバイス座標系（NDC）（$[-1,1]$の範囲に正規化）に変換する
$$
ndcX = screenX/512 \quad \quad ndcY = screenY/384
$$</p>
<p>$[0,1]$の範囲に存在する任意の$z$座標を考慮し、デバイス座標を同次座標で表すと、
$$
ndc = (ndcX, ndcY, z, 1)
$$</p>
<p>逆射影行列は、ビュー射影行列の逆行列となる
$$
Unprojection = ((View)(Procection))^{-1}
$$</p>
<p>NDCの座標に逆射影行列を掛けるとw成分が変化するが、各成分を$w$で割ることで再び正規化できる
$$
temp = (ndc)(Unprojection) \quad \quad worldPos = \frac{temp}{temp_w}
$$</p>
<h5 id="renderercpp">Renderer.cpp</h5>
<h5 id="rendererunproject">Renderer::Unproject()</h5>
<p>ビュー行列と射影行列の両方にアクセスできる唯一のクラスである<code>Renderer</code>クラスに追加する</p>
<p><code>TransformWithPerspDiv()</code>はw成分を正規化する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Convert screenPoint to device coordinates (between -1 and +1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Vector3</span> <span class="n">deviceCoord</span> <span class="o">=</span> <span class="n">screenPoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">deviceCoord</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="p">(</span><span class="n">mScreenWidth</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">deviceCoord</span><span class="p">.</span><span class="n">y</span> <span class="o">/=</span> <span class="p">(</span><span class="n">mScreenHeight</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Transform vector by unprojection matrix
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Matrix4</span> <span class="n">unprojection</span> <span class="o">=</span> <span class="n">mView</span> <span class="o">*</span> <span class="n">mProjection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">unprojection</span><span class="p">.</span><span class="n">Invert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">Vector3</span><span class="o">::</span><span class="n">TransformWithPerspDiv</span><span class="p">(</span><span class="n">deviceCoord</span><span class="p">,</span> <span class="n">unprojection</span><span class="p">);</span>
</span></span></code></pre></div><h5 id="renderergetscreendirection">Renderer::GetScreenDirection()</h5>
<p>3D空間のオブジェクトをクリックで選択する<strong>ピッキング</strong>（picking）の操作の実装では、スクリーン空間の&quot;ある点&quot;に向かう<strong>ベクトルを</strong>得ることで計算できる</p>
<p>法句おベクトルを得るため、<code>Unproject()</code>で<strong>始点</strong>と<strong>終点</strong>を変換する</p>
<p>ベクトルの引き算をした後、正規化する</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Get start point (in center of screen on near plane)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Vector3</span> <span class="nf">screenPoint</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">outStart</span> <span class="o">=</span> <span class="n">Unproject</span><span class="p">(</span><span class="n">screenPoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Get end point (in center of screen, between near and far)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">screenPoint</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.9f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Vector3</span> <span class="n">end</span> <span class="o">=</span> <span class="n">Unproject</span><span class="p">(</span><span class="n">screenPoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Get direction vector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">outDir</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">outStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">outDir</span><span class="p">.</span><span class="n">Normalize</span><span class="p">();</span>
</span></span></code></pre></div><h3 id="ゲームプロジェクト">ゲームプロジェクト</h3>
<h4 id="確認">確認</h4>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/qb--mvYbTWA" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h3 id="まとめ">まとめ</h3>
<h4 id="参考文献">参考文献</h4>
<p>ゲームのカメラに関するテクニックを紹介する書籍（筆者は&quot;メトロイドプライム&quot;用カメラシステムの主任プログラマー）：<br><a href="https://www.amazon.co.jp/%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%87%E3%82%B6%E3%82%A4%E3%83%8A%E3%83%BC%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%AB%E3%83%A1%E3%83%A9-Mark-Haigh-Hutchinson/dp/4862461204">Real Time Cameras: A Guide for Game Designers and Developers</a></p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/nishihi6" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://www.facebook.com/profile.php?id=100034856812491" target="_blank" rel="noopener noreferrer me"
    title="Facebook">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg>
</a>
<a href="https://twitter.com" target="_blank" rel="noopener noreferrer me"
    title="X">
    <svg viewBox="0 0 1200 1227" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path
        d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
</svg>
</a>
<a href="https://connpass.com/user/nishihi6/" target="_blank" rel="noopener noreferrer me"
    title="Connpass">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
</a>
<a href="http://www.igl.ise.shibaura-it.ac.jp/" target="_blank" rel="noopener noreferrer me"
    title="Lab">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
</a>
<a href="index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2024 nishihi6.
    </small>
    
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script src="https://nishihi6.github.io/blog/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js" integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30&#43;lSNuSkl4QXuNyy8="></script>

    

</body>
</html>
